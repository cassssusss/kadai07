<div class="container">
  <h1 class="my-4">施設情報の編集</h1>

  <%= form_with model: @room, local: true, html: { multipart: true } do |f| %> <!-- multipart: true はファイルアップロードに必要 -->
    <% if @room.errors.any? %>
      <div class="alert alert-danger">
        <h4><%= pluralize(@room.errors.count, "error") %>が発生しました:</h4>
        <ul>
          <% @room.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-3">
      <%= f.label :name, "施設名" %>
      <%= f.text_field :name, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :description, "説明" %>
      <%= f.text_area :description, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :price, "料金 (円/日)" %>
      <%= f.number_field :price, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :address, "住所" %>
      <%= f.text_field :address, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :image, "施設画像" %>

      <!-- 既存の画像がある場合 -->
      <% if @room.image.attached? %>
        <div class="mb-2">
          <%= image_tag url_for(@room.image), class: "img-fluid", id: "current_image" %>
        </div>
      <% end %>

      <%= f.file_field :image, class: "form-control", id: "image_input" %>
    </div>

    <div class="mb-3">
      <label class="form-label"></label>
      <img id="image_preview" src="#" alt="プレビュー画像" class="img-fluid" style="display: none;">
    </div>

    <%= f.submit "更新", class: "btn btn-primary" %>
  <% end %>

  <%= link_to '戻る', rooms_path, class: 'btn btn-secondary' %>
</div>

<script>
  document.getElementById('image_input').addEventListener('change', function(event) {
    const input = event.target;
    const preview = document.getElementById('image_preview');
    const currentImage = document.getElementById('current_image');

    if (input.files && input.files[0]) {
      const reader = new FileReader();

      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        if (currentImage) {
          currentImage.style.display = 'none';
        }
      }

      reader.readAsDataURL(input.files[0]);
    }
  });
</script>
